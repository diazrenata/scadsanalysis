---
title: "Shannon diversity"
author: Renata Diaz
date: "`r Sys.Date()`"
output: 
    github_document:
       df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)
library(grid)


all_di <- read.csv(here::here("analysis", "reports", "all_di.csv"), stringsAsFactors = F)

all_di <- all_di %>%
  mutate(log_nparts = log(gmp:::as.double.bigz(nparts)),
         log_nsamples = log(nsamples),
         log_s0 = log(s0),
         log_n0 = log(n0)) %>%
  filter(n0 != s0,
         s0 != 1,
         !singletons,
         n0 != (s0 + 1)) %>%
  mutate(dat = ifelse(grepl(dat, pattern = "fia"), "fia", dat),
         dat = ifelse(dat == "misc_abund_short", "misc_abund", dat)) %>%
  mutate(Dataset = dat,
         Dataset = ifelse(Dataset == "fia", "FIA", Dataset),
         Dataset = ifelse(Dataset == "bbs", "Breeding Bird Survey", Dataset),
         Dataset = ifelse(Dataset == "mcdb", "Mammal Communities", Dataset),
         Dataset = ifelse(Dataset == "gentry", "Gentry", Dataset),
         Dataset = ifelse(Dataset == "misc_abund", "Misc. Abundance", Dataset))

```

```{r}

  ggplot(filter(all_di), aes(shannon_percentile)) +
    geom_histogram(bins = 100) +
    geom_vline(xintercept = 5, color = "red") +
    theme_bw() +
    facet_wrap(vars(Dataset), scales = "free_y", ncol = 1) + ggtitle("Shannon's") +
    xlab("") +
    ylab("")
  


overall_shannon_results <- all_di %>%
  mutate(low_even = shannon_percentile < 5) %>%
  group_by(Dataset) %>%
  summarize(proportion_shannon_low = mean(low_even),
            nsites_even = dplyr::n())

overall_shannon_results


overall_shannon_results <- all_di %>%
  mutate(low_even = shannon_percentile < 5,
         high_even = shannon_percentile > 95) %>%
  group_by(Dataset) %>%
  summarize(proportion_shannon_low = mean(low_even),
            proportion_shannon_high = mean(high_even),
            nsites_even = dplyr::n())

overall_shannon_results
```

This is really interesting. 

- Shannon's is consistently low for most of the datasets. As with skewness and evenness, FIA has the lowest % of extremes.
- However, Gentry is actually more pronouncedly too **high** - 30% of sites are above the 95th.


```{r}
all_di <- all_di %>%
  mutate(shannon_cat = ifelse(
    shannon_percentile < 5, "low", 
    ifelse(
      shannon_percentile > 95, "high", "int"
    )
  ))

ggplot(all_di, aes(s0, n0, color = shannon_cat)) +
  theme_bw()+
  scale_x_log10() +
  scale_y_log10() +
  scale_color_viridis_d(begin = .7) +
  geom_point(data = filter(all_di, is.na(shannon_cat)), aes(s0, n0), inherit.aes = F, alpha = .05, color = "grey") +
    geom_point(alpha = .5) 



ggplot(all_di, aes(s0, n0, color = shannon_cat)) +
  theme_bw()+
  scale_x_log10() +
  scale_y_log10() +
  scale_color_viridis_d(begin = .7) +
  geom_point(data = filter(all_di, is.na(shannon_cat)), aes(s0, n0), inherit.aes = F, alpha = .1, color = "grey") +
    geom_point(alpha = .5)+
  facet_wrap(vars(Dataset))
```


The ones that come out as high are concentrated in the small region of FIA and the region of Gentry where N is closest to S. These Gentry plots are also responsible for similar behavior (not discussed in the main ms) in the other metrics.

That is, for these datasets where N/S is relatively small, the observed SADs are tending to be more even than the feasible set. 


To look at the 

- breadth index
- number of unique Shannon values

we need to re-load the samples from the feasible set. These are best done as modifications to add_all_di. 


