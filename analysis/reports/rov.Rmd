---
title: "ROV report"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)

dis <- list.files(here::here("analysis", "results"), pattern = "all_di")
all_di <- lapply(dis, FUN = function(di_df) return(mutate(read.csv(here::here("analysis", "results", di_df), stringsAsFactors = F), site = as.character(site))))
all_di <- bind_rows(all_di)

all_di <- all_di %>%
  mutate(log_nparts = log(gmp:::as.double.bigz(nparts)),
         log_nsamples = log(nsamples)) %>%
  mutate(prop_found = exp(log_nsamples - log_nparts)) %>%
  mutate(found_all = prop_found==1) %>% 
  mutate(binned_nparts = (ceiling(log_nparts/4))) %>%
  filter(nparts > 1) %>%
  group_by_all() %>%
  mutate(thresholded_nparts = min(binned_nparts, 8)) %>%
  ungroup()


diffs <- list.files(here::here("analysis", "results"), pattern = "diff_")
all_diffs <- lapply(diffs, FUN = function(di_df) return(mutate(read.csv(here::here("analysis", "results", di_df), stringsAsFactors = F), site = as.character(site))))
all_diffs <- bind_rows(all_diffs)

all_diffs <- all_diffs %>%
  select(-source)

all_di <- left_join(all_di, all_diffs)

all_di_singletons <- filter(all_di, s0 > 2, dat != "portal_plants", singletons) 

rov_long_singletons <- all_di_singletons %>%
  select(dat, site, singletons, s0, n0, skew_percentile, simpson_percentile, mean_r2, mean_cd, mean_prop_off, mean_div, log_nparts, binned_nparts, thresholded_nparts) %>%
  tidyr::pivot_longer(cols = starts_with("mean"),
                      names_to = "rov_index",
                      values_to = "val")

all_di <- filter(all_di, s0 > 2, dat != "portal_plants", !singletons)


rov_long <- all_di %>%
  select(dat, site, singletons, s0, n0, skew_percentile, simpson_percentile, mean_r2, mean_cd, mean_prop_off, mean_div, log_nparts, binned_nparts, thresholded_nparts) %>%
  tidyr::pivot_longer(cols = starts_with("mean"),
                      names_to = "rov_index",
                      values_to = "val")


bin_rov <- function(rov_vector, nbins, quantiles = F, as.fact = F) {
  
  cutoffs <- seq(from = min(rov_vector), to = 1.00001 * max(rov_vector), length.out = nbins + 1)
  
  if(quantiles) {
    cutoffs <- quantile(rov_vector, probs = seq(0, 1, length.out = nbins + 1))
    cutoffs[ length(cutoffs)] <- cutoffs[ length(cutoffs)] * 1.00001
  }
  
  binned_vect <- rov_vector

  for(i in 1:length(rov_vector)) {
    binned_vect[i] <- max(which(cutoffs <= rov_vector[i]))
  }
  
  if(as.fact) {
    binned_vect <- factor(binned_vect, ordered = T, labels = round(cutoffs[2:length(cutoffs)],digits = 1))
  }
  
  return(binned_vect)
}

rov_long <- rov_long %>%
  group_by(rov_index) %>%
  mutate(binned_val = bin_rov(val, nbins =5 ),
         qbinned_val = bin_rov(val, nbins = 5, quantiles = T),
         qbinned_lognparts = bin_rov(log_nparts, nbins = 10, quantiles = T, as.fact = T)) %>%
  ungroup()

all_di <- all_di %>%
  mutate(qbinned_lognparts = bin_rov(log_nparts, nbins = 10, quantiles = T, as.fact = T)) 

rov_long_singletons <- rov_long_singletons %>%
  group_by(rov_index) %>%
  mutate(binned_val = bin_rov(val, nbins =5 ),
         qbinned_val = bin_rov(val, nbins = 5, quantiles = T),
         qbinned_lognparts = bin_rov(log_nparts, nbins = 10, quantiles = T, as.fact = T)) %>%
  ungroup()

all_di_singletons <- all_di_singletons %>%
  mutate(qbinned_lognparts = bin_rov(log_nparts, nbins = 10, quantiles = T, as.fact = T)) 

```

# Datasets in S and N space

Here is where our communities fall in S and N space:

```{r datasets in s and n space}
ggplot(filter(all_di, singletons == F), aes(x = log(s0), y = log(n0), color = dat)) +
  geom_point(alpha = .8) +
  theme_bw() +
  theme(legend.position = "top") + scale_color_viridis_d()

```

Here is how that translates into the size of the feasible set:

```{r size of fs}
ggplot(filter(all_di, singletons == F), aes(x = log(s0), y = log(n0), color = log(log_nparts))) +
  geom_point(alpha = .5) +
  theme_bw() +
  theme(legend.position = "top") + scale_color_viridis_c()

fs_size_panels <- list(
  ggplot(filter(all_di, singletons == F), aes(x = log(s0), y = log_nparts)) +
    theme_bw() +
    geom_point(),
  ggplot(filter(all_di, singletons == F), aes(x = log(n0), y = log_nparts)) +
    theme_bw() +
    geom_point(),
  ggplot(filter(all_di, singletons == F), aes(x = log(n0 / s0), y = log_nparts)) +
    theme_bw() +
    geom_point()
)

gridExtra::grid.arrange(grobs = fs_size_panels)

```

Exploring ways we might bin nparts:

```{r nparts distribution}

ggplot(filter(all_di, singletons == F, nparts > 1), aes(log_nparts)) +
  geom_histogram(binwidth = 10, boundary = 0, color = "black", alpha = 0) +
  theme_bw()


ggplot(filter(all_di, singletons == F, nparts > 1), aes(binned_nparts)) +
  geom_histogram(binwidth = 10, boundary = 0, color = "black", alpha = 0) +
  theme_bw()


ggplot(filter(all_di, singletons == F, nparts > 1), aes(thresholded_nparts)) +
  geom_histogram(bins = 8, color = "black", alpha = 0) +
  theme_bw()

```

And various metrics of the ROV of the feasible set:

```{r fs rov}

rov_plots <- list()

for(i in 1:length(unique(rov_long$rov_index))) {
  rov_plots[[i]] <- ggplot(filter(rov_long, rov_index == unique(rov_long$rov_index)[i]), aes(log(s0), log(n0), color = val)) +
    geom_point() +
    theme_bw() +
    scale_color_viridis_c() +
    ggtitle(unique(rov_long$rov_index)[i])
}

gridExtra::grid.arrange(grobs = rov_plots)
```

Here is how ROV corresponds to nparts:

```{r rov lognparts}

rov_nparts_plots <- list()

for(i in 1:length(unique(rov_long$rov_index))) {
  rov_nparts_plots[[i]] <- ggplot(filter(rov_long, rov_index == unique(rov_long$rov_index)[i]), aes(log_nparts, val, color = dat)) +
    geom_point(alpha = .2) +
    theme_bw() +
    ggtitle(unique(rov_long$rov_index)[i]) +
    scale_color_viridis_d() +
    theme(legend.position = "none")
}

ggplot(filter(rov_long, rov_index == unique(rov_long$rov_index)[i]), aes(log_nparts, val, color = dat)) +
  geom_point() +
  scale_color_viridis_d() +
  xlim(0,0) +
  ylim(0,0) + 
  theme_minimal() +
  theme(legend.position=c(.5, .5))

for(i in 1:length(rov_nparts_plots)) {
  print(rov_nparts_plots[[i]])
}
```

Gentry behaves somewhat strangely in these plots because it has the high proportion of low N/S communities; for these communities, all elements of the FS are squished into being highly even. 


```{r binned nparts ROV}

rov_nparts_binned_plots <- list()

for(i in 1:length(unique(rov_long$rov_index))) {
  rov_nparts_binned_plots[[i]] <- ggplot(filter(rov_long, rov_index == unique(rov_long$rov_index)[i]), aes(log_nparts, val, color = log(n0/s0))) +
    geom_point(alpha = .3) +
    theme_bw() +
    ggtitle(unique(rov_long$rov_index)[i]) +
    scale_color_viridis_c(end = .9) +
    theme(legend.position = "left")
}

for(i in 1:length(rov_nparts_binned_plots)) {
  print(rov_nparts_binned_plots[[i]]) 
}

ggplot(rov_long, aes(log_nparts, val, color = log(n0/s0))) +
  geom_point(alpha = .3) +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "left") +
  facet_wrap(vars(rov_index), scales = "free_y")
```



```{r qbinned nparts ROV}

rov_nparts_qbinned_plots <- list()

for(i in 1:length(unique(rov_long$rov_index))) {
  rov_nparts_qbinned_plots[[i]] <- ggplot(filter(rov_long, rov_index == unique(rov_long$rov_index)[i]), aes(qbinned_lognparts, val, color = log(n0 / s0))) +
    geom_jitter(alpha = .1) +
    theme_bw() +
    ggtitle(unique(rov_long$rov_index)[i]) +
    scale_color_viridis_c() +
    theme(legend.position = "none")
}

for(i in 1:length(rov_nparts_qbinned_plots)) {
  print(rov_nparts_qbinned_plots[[i]]) 
}
```

Remove low N/S:


```{r qbinned nparts ROV high n}

rov_nparts_qbinned_plots_highn <- list()

for(i in 1:length(unique(rov_long$rov_index))) {
  rov_nparts_qbinned_plots_highn[[i]] <- ggplot(filter(rov_long, rov_index == unique(rov_long$rov_index)[i], log(n0 / s0) > .7), aes(qbinned_lognparts, val, color = log(n0/s0))) +
    geom_jitter(alpha = .1) +
    theme_bw() +
    ggtitle(unique(rov_long$rov_index)[i]) +
    scale_color_viridis_c() +
    theme(legend.position = "none")
}

for(i in 1:length(rov_nparts_qbinned_plots_highn)) {
  print(rov_nparts_qbinned_plots_highn[[i]]) 
}
```

## Percentile distributions

Overall:

```{r percentiles overall}

ggplot(filter(all_di, !singletons, s0 > 2, dat != "portal_plants"), aes(x = skew_percentile)) +
  geom_histogram(bins = 100, boundary = 0) +
  theme_bw()

ggplot(filter(all_di, !singletons,  dat != "portal_plants"), aes(x = simpson_percentile)) +
  geom_histogram(bins = 100, boundary = 0) +
  theme_bw()

```

Binned:

```{r binned percentiles}

ggplot(filter(all_di, !singletons, s0 > 2), aes(x = skew_percentile)) +
  geom_histogram(bins = 100, boundary = 0) +
  theme_bw() +
  facet_wrap(vars(thresholded_nparts), scales = "free_y", nrow = 2)

ggplot(filter(all_di, !singletons), aes(x = simpson_percentile)) +
  geom_histogram(bins = 100, boundary = 0) +
  theme_bw() +
  facet_wrap(vars(thresholded_nparts), scales = "free_y")

```

Binned by quantile:


```{r qbinned percentiles}

ggplot(filter(all_di, !singletons, s0 > 2), aes(x = skew_percentile)) +
  geom_histogram(bins = 100, boundary = 0) +
  theme_bw() +
  facet_wrap(vars(qbinned_lognparts), scales = "free_y", nrow = 2)

ggplot(filter(all_di, !singletons), aes(x = simpson_percentile)) +
  geom_histogram(bins = 100, boundary = 0) +
  theme_bw() +
  facet_wrap(vars(qbinned_lognparts), scales = "free_y", nrow = 2)

```

OK, these visualiations are pretty hard with this dataset (not very many small communities). Try after adding FIA?

Against ROV metrics:


```{r percentile v rov}

ggplot(rov_long, aes(x = val, y = skew_percentile)) +
  geom_point(alpha = .02) +
  theme_bw() +
  facet_wrap(vars(rov_index), scales = "free_x") +
  ylim(0, 100) +
  scale_color_viridis_c()

```


```{r bin rov}

ggplot(rov_long, aes(x = skew_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(rov_index, binned_val), scales = "free_y")


ggplot(rov_long, aes(x = skew_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(rov_index, qbinned_val), scales = "free_y")


ggplot(rov_long, aes(x = simpson_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(rov_index, binned_val), scales = "free_y")


ggplot(rov_long, aes(x = simpson_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(rov_index, qbinned_val), scales = "free_y")


```

```{r report stats}

# proportion of %iles above 95/below 5
# skew
mean(all_di$skew_percentile >= 95)
# simpson
mean(all_di$simpson_percentile <= 5)


# by nparts

nparts_summary <- all_di %>%
  group_by(qbinned_lognparts) %>%
  summarize(high_skew = mean(skew_percentile >= 95),
            low_simpson = mean(simpson_percentile <= 5)) %>%
  ungroup()


nparts_summary

eighty_smallest <- filter(all_di, log_nparts <= 8.6)
mean(eighty_smallest$skew_percentile >= 95)
mean(eighty_smallest$simpson_percentile <= 5)

twenty_largest <- filter(all_di, log_nparts >= 8.6)
mean(twenty_largest$skew_percentile >= 95)
mean(twenty_largest$simpson_percentile <= 5)

fifty_smallest <- filter(all_di, log_nparts <= median(log_nparts))
mean(fifty_smallest$simpson_percentile <= 5)
fifty_largest <- filter(all_di, log_nparts >= median(log_nparts))
mean(fifty_largest$simpson_percentile <= 5)


```

### Rarefaction
```{r rarefaction percentiles overall}

ggplot(all_di_singletons, aes(x = skew_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw()

ggplot(all_di_singletons, aes(x = simpson_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw()
```

```{r rarefaction percentiles binned by nparts}

ggplot(all_di_singletons, aes(x = skew_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(qbinned_lognparts), scales = "free_y", nrow = 2)


ggplot(all_di_singletons, aes(x = simpson_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(qbinned_lognparts), scales = "free_y", nrow = 2)

```

```{r rarefaction change}

all_di_change <- select(all_di, dat, site, singletons, s0, n0, log_nparts, qbinned_lognparts, skew_percentile, simpson_percentile) %>%
  bind_rows(select(all_di_singletons, dat, site, singletons, s0, n0, skew_percentile, simpson_percentile)) %>%
  tidyr::pivot_wider(names_from = singletons, values_from = c(s0, n0, skew_percentile, simpson_percentile, log_nparts, qbinned_lognparts)) %>%
  select(-log_nparts_TRUE, -qbinned_lognparts_TRUE) %>%
  filter(!is.na(s0_FALSE)) %>%
  mutate(s0_change = s0_TRUE - s0_FALSE,
         n0_change = n0_TRUE - n0_FALSE,
         skew_change = skew_percentile_TRUE - skew_percentile_FALSE,
         even_change = simpson_percentile_TRUE - simpson_percentile_FALSE)


ggplot(all_di_change, aes(skew_percentile_FALSE, skew_percentile_TRUE)) +
  geom_point(alpha = .2) +
  theme_bw() +
  xlim(0, 100) +
  ylim(0, 100) +
  geom_abline(intercept = 0, slope = 1, color = "orange")


ggplot(all_di_change, aes(log(s0_FALSE), log(n0_FALSE), color = skew_percentile_TRUE < skew_percentile_FALSE)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_d(begin = .1, end = .9) +
  theme(legend.position = "top")


ggplot(all_di_change, aes(skew_percentile_FALSE, skew_percentile_TRUE)) +
  geom_point(alpha = .2) +
  theme_bw() +
  facet_wrap(vars(qbinned_lognparts_FALSE), nrow = 2) +
  xlim(0, 100) +
  ylim(0, 100) +
  geom_abline(intercept = 0, slope = 1, color = "orange")


ggplot(all_di_change, aes(simpson_percentile_FALSE, simpson_percentile_TRUE)) +
  geom_point(alpha = .2) +
  theme_bw() +
  xlim(0, 100) +
  ylim(0, 100) +
  geom_abline(intercept = 0, slope = 1, color = "orange")
ggplot(all_di_change, aes(simpson_percentile_FALSE, simpson_percentile_TRUE)) +
  geom_point(alpha = .2) +
  theme_bw() +
  facet_wrap(vars(qbinned_lognparts_FALSE), nrow = 2) +
  xlim(0, 100) +
  ylim(0, 100) +
  geom_abline(intercept = 0, slope = 1, color = "orange")
```

```{r rarefaction stats}
# proportion of %iles above 95/below 5
# skew
mean(all_di_singletons$skew_percentile >= 95)
# simpson
mean(all_di_singletons$simpson_percentile <= 5)


nparts_summary2 <- all_di_singletons %>%
  group_by(qbinned_lognparts) %>%
  summarize(high_skew = mean(skew_percentile >= 95),
            low_simpson = mean(simpson_percentile <= 5)) %>%
  ungroup()


nparts_summary2


```
