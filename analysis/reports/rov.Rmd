---
title: "ROV report"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)

dis <- list.files(here::here("analysis", "results"), pattern = "all_di")
all_di <- lapply(dis, FUN = function(di_df) return(mutate(read.csv(here::here("analysis", "results", di_df), stringsAsFactors = F), site = as.character(site))))
all_di <- bind_rows(all_di)

all_di <- all_di %>%
  mutate(log_nparts = log(gmp:::as.double.bigz(nparts)),
         log_nsamples = log(nsamples)) %>%
  mutate(prop_found = exp(log_nsamples - log_nparts)) %>%
  mutate(found_all = prop_found==1) %>% 
  mutate(binned_nparts = (ceiling(log_nparts/4))) %>%
  filter(nparts > 1) %>%
  group_by_all() %>%
  mutate(thresholded_nparts = min(binned_nparts, 8)) %>%
  ungroup()


diffs <- list.files(here::here("analysis", "results"), pattern = "diff_")
all_diffs <- lapply(diffs, FUN = function(di_df) return(mutate(read.csv(here::here("analysis", "results", di_df), stringsAsFactors = F), site = as.character(site))))
all_diffs <- bind_rows(all_diffs)

all_diffs <- all_diffs %>%
  select(-source)

all_di <- left_join(all_di, all_diffs)

all_di <- filter(all_di, s0 > 2)
```

# Datasets in S and N space

Here is where our communities fall in S and N space:

```{r datasets in s and n space}
ggplot(filter(all_di, singletons == F), aes(x = log(s0), y = log(n0), color = dat)) +
  geom_point(alpha = .8) +
  theme_bw() +
  theme(legend.position = "top") + scale_color_viridis_d()

```

Here is how that translates into the size of the feasible set:

```{r size of fs}
ggplot(filter(all_di, singletons == F), aes(x = log(s0), y = log(n0), color = log_nparts)) +
  geom_point(alpha = .5) +
  theme_bw() +
  theme(legend.position = "top") + scale_color_viridis_c(option = "magma", end = .9, begin = .1)

```

Exploring ways we might bin nparts:

```{r nparts distribution}

ggplot(filter(all_di, singletons == F, nparts > 1), aes(log_nparts)) +
  geom_histogram(binwidth = 10, boundary = 0, color = "black", alpha = 0) +
  theme_bw()


ggplot(filter(all_di, singletons == F, nparts > 1), aes(binned_nparts)) +
  geom_histogram(binwidth = 10, boundary = 0, color = "black", alpha = 0) +
  theme_bw()


ggplot(filter(all_di, singletons == F, nparts > 1), aes(thresholded_nparts)) +
  geom_histogram(bins = 8, color = "black", alpha = 0) +
  theme_bw()

```

And various metrics of the ROV of the feasible set:

```{r fs rov}

rov_long <- all_di %>%
  select(dat, site, singletons, s0, n0, skew_percentile, simpson_percentile, mean_r2, mean_cd, mean_prop_off, mean_div, log_nparts, binned_nparts, thresholded_nparts) %>%
  tidyr::pivot_longer(cols = starts_with("mean"),
                      names_to = "rov_index",
                      values_to = "val")


bin_rov <- function(rov_vector, nbins, quantiles = F) {
  
  cutoffs <- seq(from = min(rov_vector), to = 1.00001 * max(rov_vector), length.out = nbins + 1)
  
  if(quantiles) {
    cutoffs <- quantile(rov_vector, probs = seq(0, 1, length.out = nbins + 1))
    cutoffs[ length(cutoffs)] <- cutoffs[ length(cutoffs)] * 1.00001
  }
  
  binned_vect <- rov_vector

  for(i in 1:length(rov_vector)) {
    binned_vect[i] <- max(which(cutoffs <= rov_vector[i]))
  }
  
  return(binned_vect)
}

rov_long <- rov_long %>%
  group_by(rov_index) %>%
  mutate(binned_val = bin_rov(val, nbins =5 ),
         qbinned_val = bin_rov(val, nbins = 5, quantiles = T)) %>%
  ungroup()

rov_plots <- list()

for(i in 1:length(unique(rov_long$rov_index))) {
  rov_plots[[i]] <- ggplot(filter(rov_long, rov_index == unique(rov_long$rov_index)[i]), aes(log(s0), log(n0), color = val)) +
    geom_point() +
    theme_bw() +
    scale_color_viridis_c() +
    ggtitle(unique(rov_long$rov_index)[i])
}

gridExtra::grid.arrange(grobs = rov_plots)
```

Here is how ROV corresponds to nparts:

```{r rov lognparts}

rov_nparts_plots <- list()

for(i in 1:length(unique(rov_long$rov_index))) {
  rov_nparts_plots[[i]] <- ggplot(filter(rov_long, rov_index == unique(rov_long$rov_index)[i]), aes(log_nparts, val, color = dat)) +
    geom_point(alpha = .2) +
    theme_bw() +
    ggtitle(unique(rov_long$rov_index)[i]) +
    geom_vline(xintercept = 10) +
    scale_color_viridis_d() +
    theme(legend.position = "none")
}

ggplot(filter(rov_long, rov_index == unique(rov_long$rov_index)[i]), aes(log_nparts, val, color = dat)) +
  geom_point() +
  scale_color_viridis_d() +
  xlim(0,0) +
  ylim(0,0) + 
  theme_minimal() +
  theme(legend.position=c(.5, .5))

for(i in 1:length(rov_nparts_plots)) {
  print(rov_nparts_plots[[i]])
}
```

Gentry behaves somewhat strangely in these plots because it has the high proportion of low N/S communities; for these communities, all elements of the FS are squished into being highly even. 

If we bin nparts:

```{r binned nparts ROV}

rov_nparts_binned_plots <- list()

for(i in 1:length(unique(rov_long$rov_index))) {
  rov_nparts_binned_plots[[i]] <- ggplot(filter(rov_long, rov_index == unique(rov_long$rov_index)[i]), aes(log_nparts, val, color = as.factor(thresholded_nparts))) +
    geom_point(alpha = .1) +
    theme_bw() +
    ggtitle(unique(rov_long$rov_index)[i]) +
    scale_color_viridis_d() +
    theme(legend.position = "none")
}

for(i in 1:length(rov_nparts_binned_plots)) {
  print(rov_nparts_binned_plots[[i]]) 
}
```

## Percentile distributions

Overall:

```{r percentiles overall}

ggplot(filter(all_di, !singletons, s0 > 2, dat != "portal_plants"), aes(x = skew_percentile)) +
  geom_histogram(bins = 100, boundary = 0) +
  theme_bw()

ggplot(filter(all_di, !singletons,  dat != "portal_plants"), aes(x = simpson_percentile)) +
  geom_histogram(bins = 100, boundary = 0) +
  theme_bw()

```

Binned:

```{r binned percentiles}

ggplot(filter(all_di, !singletons, s0 > 2), aes(x = skew_percentile)) +
  geom_histogram(bins = 100, boundary = 0) +
  theme_bw() +
  facet_wrap(vars(thresholded_nparts), scales = "free_y", nrow = 2)

ggplot(filter(all_di, !singletons), aes(x = simpson_percentile)) +
  geom_histogram(bins = 100, boundary = 0) +
  theme_bw() +
  facet_wrap(vars(thresholded_nparts), scales = "free_y")

```

OK, these visualiations are pretty hard with this dataset (not very many small communities). Try after adding FIA?

Against ROV metrics:


```{r percentile v rov}

ggplot(rov_long, aes(x = val, y = skew_percentile)) +
  geom_point(alpha = .02) +
  theme_bw() +
  facet_wrap(vars(rov_index), scales = "free_x") +
  ylim(0, 100) +
  scale_color_viridis_c()

```


```{r bin rov}

ggplot(rov_long, aes(x = skew_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(rov_index, binned_val), scales = "free_y")


ggplot(rov_long, aes(x = skew_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(rov_index, qbinned_val), scales = "free_y")


ggplot(rov_long, aes(x = simpson_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(rov_index, binned_val), scales = "free_y")


ggplot(rov_long, aes(x = simpson_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(rov_index, qbinned_val), scales = "free_y")


```
