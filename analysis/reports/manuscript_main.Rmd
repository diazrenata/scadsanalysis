---
title: "Figures and results for main manuscript"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)

all_di <- read.csv(here::here("analysis", "reports", "all_di.csv"), stringsAsFactors = F)

all_di <- all_di %>%
  mutate(log_nparts = log(gmp:::as.double.bigz(nparts)),
         log_nsamples = log(nsamples),
         log_s0 = log(s0),
         log_n0 = log(n0)) %>%
  filter(n0 > s0,
         !singletons,
         dat %in% c("bbs", "fia_short", "fia_small", "gentry", "mcdb", "misc_abund_short")) %>%
  mutate(dat = ifelse(grepl(dat, pattern = "fia"), "fia", dat),
         dat = ifelse(dat == "misc_abund_short", "misc_abund", dat))
```

# Final dataset in S and N space

```{r final dataset s and n space}

ggplot(all_di, aes(x = log_s0, y = log_n0, color = dat)) +
  geom_point(alpha = .4) +
  theme_bw() +
  scale_color_viridis_d() +
  ggtitle("Communities by S and N")

```


# Illustrations of 95% interval

To show the 95% interval, we need to load the distribution of shape metric values from the samples from the feasible set for a few communities. 

# Skewness and evenness histograms by dataset

```{r res}

ggplot(filter(all_di, s0 > 2), aes(skew_percentile)) +
  geom_histogram() +
  geom_vline(xintercept = 95, color = "red") +
  theme_bw() +
  facet_wrap(vars(dat), scales = "free_y") + ggtitle("Skewness, all sites")
# 
# ggplot(filter(all_di, s0 > 2, nsamples > 200), aes(skew_percentile)) +
#   geom_histogram() +
#   geom_vline(xintercept = 95, color = "red") +
#   theme_bw() +
#     facet_wrap(vars(dat), scales = "free_y") + ggtitle("Skewness, >200 samples")
# 
# 
# ggplot(filter(all_di, s0 > 2, nsamples > 500), aes(skew_percentile)) +
#   geom_histogram() +
#   geom_vline(xintercept = 95, color = "red") +
#   theme_bw() +
#     facet_wrap(vars(dat), scales = "free_y") + ggtitle("Skewness, >500 samples")
# 
# 
# ggplot(filter(all_di, s0 > 2, nsamples > 1000), aes(skew_percentile)) +
#   geom_histogram() +
#   geom_vline(xintercept = 95, color = "red") +
#   theme_bw() +
#     facet_wrap(vars(dat), scales = "free_y") + ggtitle("Skewness, >1000 samples")
# 
# ggplot(filter(all_di, s0 > 2, nsamples > 2500), aes(skew_percentile)) +
#   geom_histogram() +
#   geom_vline(xintercept = 95, color = "red") +
#   theme_bw() +
#     facet_wrap(vars(dat), scales = "free_y") + ggtitle("Skewness, >2500 samples")
# 
# 
# ggplot(filter(all_di, s0 > 2, nsamples == 4000), aes(skew_percentile)) +
#   geom_histogram() +
#   geom_vline(xintercept = 95, color = "red") +
#   theme_bw() +
#     facet_wrap(vars(dat), scales = "free_y") + ggtitle("Skewness, 4000 samples")

```
# Nsamples cutoff

```{r nsamples cutoff}

samples_cutoffs = seq(0, 4000, by = 100)

samples_cutoff_dfs <- list() 

for(i in 1:length(samples_cutoffs)) {
  
  this_df <- all_di %>%
    filter(nsamples >= samples_cutoffs[i])
  
  skew_prop <- filter(this_df, s0 > 2) %>%
    mutate(skew_above_95 = skew_percentile >= 95) %>%
    group_by(dat) %>%
    summarize(prop_skew_high = mean(skew_above_95)) %>%
    ungroup() %>%
    mutate(nsamples_cutoff = samples_cutoffs[i])
  
  simpson_prop <- this_df %>%
    mutate(simpson_below_05 = simpson_percentile <= 5) %>%
    group_by(dat) %>%
    summarize(prop_simpson_low = mean(simpson_below_05)) %>%
    ungroup() %>%
    mutate(nsamples_cutoff = samples_cutoffs[i])
  
  samples_cutoff_dfs[[i]] <- left_join(skew_prop, simpson_prop)
  
}

samples_cutoffs_df <- bind_rows(samples_cutoff_dfs)

overall <- filter(samples_cutoffs_df, nsamples_cutoff == 0) %>%
  select(-nsamples_cutoff) %>%
  rename(overall_high_skew= prop_skew_high ,
         overall_low_simpson = prop_simpson_low)
samples_cutoffs_df <- left_join(samples_cutoffs_df, overall)


ggplot(samples_cutoffs_df, aes(nsamples_cutoff, prop_skew_high, color=dat)) +
  geom_point() +
  geom_line(aes(y = overall_high_skew)) +
  theme_bw() +
  ylim(0, .5) +
  geom_hline(yintercept = .05) +
  facet_wrap(vars(dat))


ggplot(samples_cutoffs_df, aes(nsamples_cutoff, prop_simpson_low, color=dat)) +
  geom_point() +
  geom_line(aes(y = overall_low_simpson)) +
  theme_bw() +
  geom_hline(yintercept = .05) +
  facet_wrap(vars(dat))


```

If you remove the very smallest FIA communities (those that achieved the very fewest samples) you get a "significant" effect even for very low thresholds. 

# Nparts cutoff

```{r nparts cutoff}

parts_cutoffs = seq(0, 320, by = 2)

parts_cutoff_dfs <- list() 

for(i in 1:length(parts_cutoffs)) {
  
  this_df <- all_di %>%
    filter(log_nparts >= parts_cutoffs[i])
  
  skew_prop <- filter(this_df, s0 > 2) %>%
    mutate(skew_above_95 = skew_percentile >= 95) %>%
    group_by(dat) %>%
    summarize(prop_skew_high = mean(skew_above_95),
              nsites = dplyr::n()) %>%
    ungroup() %>%
    mutate(nparts_cutoff = parts_cutoffs[i])
  
  simpson_prop <- this_df %>%
    mutate(simpson_below_05 = simpson_percentile <= 5) %>%
    group_by(dat) %>%
    summarize(prop_simpson_low = mean(simpson_below_05),
              nsites = dplyr::n()) %>%
    ungroup() %>%
    mutate(nparts_cutoff = parts_cutoffs[i])
  
  parts_cutoff_dfs[[i]] <- left_join(skew_prop, simpson_prop)
  
}

parts_cutoffs_df <- bind_rows(parts_cutoff_dfs)

overall <- filter(parts_cutoffs_df, nparts_cutoff == 0) %>%
  select(-nparts_cutoff) %>%
  rename(overall_high_skew= prop_skew_high ,
         overall_low_simpson = prop_simpson_low,
         total_sites = nsites)

parts_cutoffs_df <- left_join(parts_cutoffs_df, overall) %>%
  mutate(prop_sites = nsites / total_sites)


ggplot(parts_cutoffs_df, aes(nparts_cutoff, prop_skew_high, color=dat)) +
  geom_point() +
  geom_line(aes(y = overall_high_skew)) +
  geom_line(aes(y = prop_sites), color = "red") +
  theme_bw() +
  geom_hline(yintercept = .05) +
  facet_wrap(vars(dat), scales = "free")


ggplot(parts_cutoffs_df, aes(nparts_cutoff, prop_simpson_low, color=dat)) +
  geom_point() +
  geom_line(aes(y = overall_low_simpson)) +
    geom_line(aes(y = prop_sites), color = "red") +
  theme_bw() +
  geom_hline(yintercept = .05) +
  facet_wrap(vars(dat), scales = "free_x")

ggplot(all_di, aes(x = log_nparts, y = nsamples)) + geom_point() + geom_vline(xintercept = 5) + xlim(0, 15)


```

# 95% interval for small versus large communities


```{r 95 interval}

ggplot(all_di, aes(x = log_nparts, y = skew_95_ratio_1t, color = nsamples)) +
  geom_point() +
  facet_wrap(vars(dat)) +
  xlim(0, 30)


ggplot(all_di, aes(x = log_nparts, y = simpson_95_ratio_1t, color = nsamples)) +
  geom_point() +
  facet_wrap(vars(dat))

```


# Comparison of FIA to similarly-sized communities


```{r fia sized}
fia_max_s <- max(filter(all_di, dat == "fia")$s0)
fia_max_n <- max(filter(all_di, dat == "fia")$n0)

fia_sized <- filter(all_di, s0 <= fia_max_s,n0 <= fia_max_n) %>%
  mutate(fia_yn = dat == "fia")

ggplot(filter(fia_sized, s0 > 2), aes(skew_percentile)) +
  geom_histogram() +
  facet_wrap(vars(fia_yn), scales = "free_y")

ggplot(filter(fia_sized, s0 > 2, nsamples > 100), aes(skew_percentile)) +
  geom_histogram() +
  facet_wrap(vars(fia_yn), scales = "free_y")

ggplot(fia_sized, aes(log_nparts, log_nsamples)) +
  geom_point()
```
