---
title: "Size class small comparisons"
author: Renata Diaz
date: "`r Sys.Date()`"
output: 
    github_document:
       df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)
knitr::opts_chunk$set(fig.width=4, fig.height=3, warning = FALSE, message = FALSE) 
```


```{r real data, include=FALSE}

all_di <- read.csv(here::here("analysis", "reports", "all_di.csv"), stringsAsFactors = F)

all_di <- all_di %>%
  mutate(log_nparts = log(gmp:::as.double.bigz(nparts)),
         log_nsamples = log(nsamples),
         log_s0 = log(s0),
         log_n0 = log(n0)) %>%
  filter(n0 > s0,
         !singletons,
         dat %in% c("bbs", "fia_short", "fia_small", "gentry", "mcdb", "misc_abund_short")) %>%
  mutate(dat = ifelse(grepl(dat, pattern = "fia"), "fia", dat),
         dat = ifelse(dat == "misc_abund_short", "misc_abund", dat))
```

##### Results for small (FIA sized) communities

Here are the results when we try to tell whether FIA communities differ qualitatively from similarly-sized communities from other datasets...

###### Small sites

Note that, even for small sites, "other datasets" are generally larger than FIA....

```{r small, fig.dim = c(4,3)}


fia_max_s = max(filter(all_di, dat == "fia")$s0)
fia_max_n = max(filter(all_di, dat == "fia")$n0)

fia = filter(all_di, dat == "fia")

small_di <- all_di %>%
  filter(s0 <= fia_max_s,
         n0 <= fia_max_n) %>%
  mutate(fia_yn = ifelse(dat == "fia", "fia", "other datasets"),
         right_corner = FALSE)

for(i in 1:nrow(small_di)) {
  if(small_di$dat[i] != "fia") {
    fia_match_s0 = filter(fia, s0 >= small_di$s0[i])
    
    max_n0_for_this_s0 = max(fia_match_s0$n0)
    
    small_di$right_corner[i] = small_di$n0[i] > max_n0_for_this_s0
    
  }
}


small_di <- small_di %>%
  filter(!right_corner)

ggplot(small_di, aes(x = s0, y = n0, color = log_nparts)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .7) +
  facet_wrap(vars(fia_yn)) +
  theme(legend.position = "top")

ggplot(small_di, aes(log_nparts)) +
  geom_histogram(bins = 30) +
  theme_bw() +
  facet_wrap(vars(fia_yn), scales = "free_y")

```

Having played around with the shiny app (size_comparisons), here are some static plots that I think are faithful to what I glean from tinkering with cutoffs. 

##### Trivially small

For a range of about 1-300 elements in the FS, I wouldn't argue for any kind of detectable pattern in any of the results:

```{r trivially small}

minparts = 1
maxparts = 300

this_di <- small_di %>%
            filter(nparts > minparts,
                   nparts < maxparts)

        ggplot(small_di, aes(x = (s0), y = (n0))) +
            geom_point() +
            geom_point(data = this_di, color = "blue") +
            theme_bw() +
            facet_wrap(vars(fia_yn))

    
        
ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts,
              s0 > 2), aes(skew_percentile_excl)) +
  geom_histogram(bins = 100) +
  facet_wrap(vars(fia_yn), scales = "free_y") +
  theme_bw()


 ggplot(small_di, aes(log_nparts)) +
            geom_histogram(bins = 30) +
            theme_bw() +
            facet_wrap(vars(fia_yn), scales = "free_y") +
            geom_vline(xintercept = c(log(minparts),
                                      log(maxparts)), color = "red")


ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(simpson_percentile)) +
  geom_histogram(bins = 100) +
  facet_wrap(vars(fia_yn), scales = "free_y") +
  theme_bw()

ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(skew_95_ratio_1t)) +
         geom_histogram() +
         theme_bw()

ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(simpson_95_ratio_1t)) +
         geom_histogram() +
         theme_bw()
small_di %>%
  filter(nparts< maxparts, nparts > minparts,
         s0 > 2) %>%
  group_by(fia_yn) %>%
  summarize(prop_skew_high = mean(skew_percentile_excl > 95),
            nskew_sites = dplyr::n())

small_di %>%
  filter(nparts< maxparts, nparts > minparts) %>% 
  group_by(fia_yn) %>%
  summarize(prop_even_low = mean(simpson_percentile < 5),
            neven_sites = dplyr::n())



```

##### Small but not trivially small

There's one dynamic from a minimum of around 50 to 10000 elements, where:

- Not really anything detectable for skewness
- A weak effect for evenness for FIA, and quite a strong effect for evenness for other datasets

```{r medium small}

minparts = 50
maxparts = 10000

this_di <- small_di %>%
            filter(nparts > minparts,
                   nparts < maxparts)

        ggplot(small_di, aes(x = (s0), y = (n0))) +
            geom_point() +
            geom_point(data = this_di, color = "blue") +
            theme_bw() +
            facet_wrap(vars(fia_yn))

ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts,
              s0 > 2), aes(skew_percentile_excl)) +
  geom_histogram(bins = 100) +
  facet_wrap(vars(fia_yn), scales = "free_y") +
  theme_bw()
 ggplot(small_di, aes(log_nparts)) +
            geom_histogram(bins = 30) +
            theme_bw() +
            facet_wrap(vars(fia_yn), scales = "free_y") +
            geom_vline(xintercept = c(log(minparts),
                                      log(maxparts)), color = "red")
ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(simpson_percentile)) +
  geom_histogram(bins = 100) +
  facet_wrap(vars(fia_yn), scales = "free_y") +
  theme_bw()

ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(skew_95_ratio_1t)) +
         geom_histogram() +
         theme_bw()

ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(simpson_95_ratio_1t)) +
         geom_histogram() +
         theme_bw()
small_di %>%
  filter(nparts< maxparts, nparts > minparts,
         s0 > 2) %>%
  group_by(fia_yn) %>%
  summarize(prop_skew_high = mean(skew_percentile_excl > 95),
            nskew_sites = dplyr::n())

small_di %>%
  filter(nparts< maxparts, nparts > minparts) %>% 
  group_by(fia_yn) %>%
  summarize(prop_even_low = mean(simpson_percentile < 5),
            neven_sites = dplyr::n())



```


##### Big

And then anything over about 1500 elements:

- Effects for both skewness and evenness, which only get stronger as you increase the minimum
- Consistently more pronounced for other datasets for FIA, but the difference decreases as you increase the minimum

```{r big}

minparts = 1500
maxparts = exp(30)

this_di <- small_di %>%
            filter(nparts > minparts,
                   nparts < maxparts)

        ggplot(small_di, aes(x = (s0), y = (n0))) +
            geom_point() +
            geom_point(data = this_di, color = "blue") +
            theme_bw() +
            facet_wrap(vars(fia_yn))

ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts,
              s0 > 2), aes(skew_percentile_excl)) +
  geom_histogram(bins = 100) +
  facet_wrap(vars(fia_yn), scales = "free_y") +
  theme_bw()
 ggplot(small_di, aes(log_nparts)) +
            geom_histogram(bins = 30) +
            theme_bw() +
            facet_wrap(vars(fia_yn), scales = "free_y") +
            geom_vline(xintercept = c(log(minparts),
                                      log(maxparts)), color = "red")
ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(simpson_percentile)) +
  geom_histogram(bins = 100) +
  facet_wrap(vars(fia_yn), scales = "free_y") +
  theme_bw()

ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(skew_95_ratio_1t)) +
         geom_histogram() +
         theme_bw()

ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(simpson_95_ratio_1t)) +
         geom_histogram() +
         theme_bw()
small_di %>%
  filter(nparts< maxparts, nparts > minparts,
         s0 > 2) %>%
  group_by(fia_yn) %>%
  summarize(prop_skew_high = mean(skew_percentile_excl > 95),
            nskew_sites = dplyr::n())

small_di %>%
  filter(nparts< maxparts, nparts > minparts) %>% 
  group_by(fia_yn) %>%
  summarize(prop_even_low = mean(simpson_percentile < 5),
            neven_sites = dplyr::n())



```


##### Really big

Such that, over about 10000 elements, FIA looks similar to other datasets. 

```{r really big}

minparts = 10000
maxparts = exp(30)

this_di <- small_di %>%
            filter(nparts > minparts,
                   nparts < maxparts)

        ggplot(small_di, aes(x = (s0), y = (n0))) +
            geom_point() +
            geom_point(data = this_di, color = "blue") +
            theme_bw() +
            facet_wrap(vars(fia_yn))

ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts,
              s0 > 2), aes(skew_percentile_excl)) +
  geom_histogram(bins = 100) +
  facet_wrap(vars(fia_yn), scales = "free_y") +
  theme_bw()

 ggplot(small_di, aes(log_nparts)) +
            geom_histogram(bins = 30) +
            theme_bw() +
            facet_wrap(vars(fia_yn), scales = "free_y") +
            geom_vline(xintercept = c(log(minparts),
                                      log(maxparts)), color = "red")
ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(simpson_percentile)) +
  geom_histogram(bins = 100) +
  facet_wrap(vars(fia_yn), scales = "free_y") +
  theme_bw()

ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(skew_95_ratio_1t)) +
         geom_histogram() +
         theme_bw()

ggplot(filter(small_di,
              nparts< maxparts, nparts > minparts), aes(simpson_95_ratio_1t)) +
         geom_histogram() +
         theme_bw()
small_di %>%
  filter(nparts< maxparts, nparts > minparts,
         s0 > 2) %>%
  group_by(fia_yn) %>%
  summarize(prop_skew_high = mean(skew_percentile_excl > 95),
            nskew_sites = dplyr::n())

small_di %>%
  filter(nparts< maxparts, nparts > minparts) %>% 
  group_by(fia_yn) %>%
  summarize(prop_even_low = mean(simpson_percentile < 5),
            neven_sites = dplyr::n())



```
