---
title: "Singletons"
output: 
  github_document
params:
  on_hpg: [FALSE]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)
library(scadsanalysis)

if(params$on_hpg) {
  
  all_di <- list() 
  datasets <- c("bbs", "fia_short", "gentry", "mcdb", "misc_abund_short", "portal_plants")
  
  #datasets <- c("fia", "gentry", "mcdb", "misc_abund_short", "portal_plants")
  
  for(i in 1:length(datasets)) {
    
    this_dataset = datasets[i]
    if(this_dataset == "misc_abund_short") {
      cache_loc = "miscabund"
    } else if(this_dataset == "fia_short") {
      
      cache_loc = "fia"
    } else {
      cache_loc = this_dataset
    }
    
    ## Set up the cache and config
    db <- DBI::dbConnect(RSQLite::SQLite(), here::here("analysis", "drake", paste0("drake-cache-", cache_loc, ".sqlite")))
    cache <- storr::storr_dbi("datatable", "keystable", db)
    
    all_di[[i]] <- readd(all_di_obs, cache = cache)
    
    all_di[[i]] <- filter(all_di[[i]], source == "observed")
    
    this_dat <- readd(paste0("dat_s_dat_", this_dataset), cache = cache, character_only = T)
    sv <- get_statevars(this_dat)
    all_di[[i]] <- left_join(all_di[[i]], sv, by = c("sim", "site", "source", "singletons", "dat"))
    
    
    DBI::dbDisconnect(db)
    rm(cache)
    rm(db)
  }
  
  
  all_di <- bind_rows(all_di)
  
  write.csv(all_di, "all_di.csv", row.names = F)
} else {
  all_di <- read.csv(here::here("analysis", "reports", "all_di.csv"), stringsAsFactors = F)
}
```

# Effect of singletons

```{r singletons overall}

singletons_effect <- all_di %>%
  select(dat, nsamples, site, singletons, skew_percentile, simpson_percentile) %>%
  tidyr::pivot_wider(names_from = singletons, values_from = c(skew_percentile, simpson_percentile, nsamples)) %>%
  mutate(skewdiff = skew_percentile_TRUE - skew_percentile_FALSE,
         simpdiff= simpson_percentile_TRUE - simpson_percentile_FALSE) %>%
  filter(nsamples_TRUE >= 2000, nsamples_FALSE >= 2000)

ggplot(data = singletons_effect, aes(x = skew_percentile_FALSE, y = skew_percentile_TRUE)) +
  geom_point(alpha = .2) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green")

ggplot(data = singletons_effect, aes(x = simpson_percentile_FALSE, y = simpson_percentile_TRUE)) +
    geom_point(alpha = .2) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green")

```

The rarefaction-inflated datasets are strongly // the raw vectors. They have more extreme skewness and evenness values, relative to their feasible sets, than the raw vectors. This is almost always true for evenness, with a little more noise in the skewness signal. But either way, very strong. 

## Broken out by dataset

```{r dataset, fig.dim = c(10,10)}

make_dat_hist <- function(datname, varname, data) {
  
  if(varname == "skew") {
  
  dat_hist <- ggplot(data = filter(data, nsamples >= 2000, singletons == FALSE, dat == datname), aes(x = skew_percentile)) 
  } else if (varname == "simpson") {
       dat_hist <- ggplot(data = filter(data, nsamples >= 2000, singletons == FALSE, dat == datname), aes(x = simpson_percentile)) 
    }
  
  dat_hist <- dat_hist +
 geom_histogram(bins = 100, aes(y = stat(count / sum(count)))) +
  theme_bw() +
  geom_hline(yintercept = .01, linetype = 3) +
    ggtitle(paste0(datname, ": ", varname))
  
  return(dat_hist)
}

simp_hists <- lapply(as.list(unique(all_di$dat)), FUN = make_dat_hist, varname = "simpson", data = all_di)

skew_hists <- lapply(as.list(unique(all_di$dat)), FUN = make_dat_hist, varname = "skew", data = all_di)

gridExtra::grid.arrange(grobs = simp_hists)

gridExtra::grid.arrange(grobs = skew_hists)

```


Evennes is consistently more concentrated in the extremes than skewness. 

Gentry has a weird U going on, where it has a lot of weirdly *low*/*high* values. All the others are concentrated as low (evenness) or high (skew). BBS and FIA have the most that are in the intermediate zone.

Effect of singletons

```{r singletons dataset}

singletons_effect <- all_di %>%
  select(dat, nsamples, site, singletons, skew_percentile, simpson_percentile, s0, n0) %>%
  tidyr::pivot_wider(names_from = singletons, values_from = c(skew_percentile, simpson_percentile, nsamples, s0, n0)) %>%
  mutate(skewdiff = skew_percentile_TRUE - skew_percentile_FALSE,
         simpdiff= simpson_percentile_TRUE - simpson_percentile_FALSE,
         nadded = s0_TRUE - s0_FALSE,
         propadded = (s0_TRUE - s0_FALSE) / s0_FALSE) %>%
  filter(nsamples_TRUE >= 2000, nsamples_FALSE >= 2000)

ggplot(data = singletons_effect, aes(x = skew_percentile_FALSE, y = skew_percentile_TRUE, color = log(nadded))) +
  geom_point(alpha = .2) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green") +
  facet_wrap(vars(dat)) +
  scale_color_viridis_c(option = "plasma")

ggplot(data = singletons_effect, aes(x = simpson_percentile_FALSE, y = simpson_percentile_TRUE, color = log(nadded))) +
    geom_point(alpha = .2) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green") +
  facet_wrap(vars(dat))+
  scale_color_viridis_c(option = "plasma")

```

There's some fuzz, most pronouncedly for BBS and FIA. Those are also the ones with 1) the most points and 2) the most fuzz/uniform-distributed percentile values. 

```{r sv singletons}

ggplot(data = singletons_effect, aes(x = dat, y = nadded)) +
  geom_boxplot() +
  theme_bw()

ggplot(data = singletons_effect, aes(x = dat, y = propadded)) +
  geom_boxplot() +
  theme_bw()

ggplot(data = singletons_effect, aes(x = log(s0_FALSE), y= log(n0_FALSE), color = log(nadded))) +
  geom_point(alpha = .1) +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9, direction = -1) +
  theme(legend.position = "top") 
  

ggplot(data = singletons_effect, aes(x = log(s0_FALSE), y= log(n0_FALSE), color = log(propadded))) +
  geom_point(alpha = .1) +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9, direction = -1) +
  theme(legend.position = "top")

ggplot(data = filter(singletons_effect, skewdiff < 0), aes(x = log(s0_FALSE), y= log(n0_FALSE), color = skewdiff)) +
  geom_point(data = singletons_effect, alpha = .07, color = "grey")+
    geom_point(alpha = .5) + 
facet_wrap(vars(dat), scales = "free") +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9, direction = 1) +
  theme(legend.position = "top")



```

Gentry gets a bunch of species added (600?!?!?!?). Otherwise, the number added and the effect doesn't map clearly onto S and N.


Gentry makes things hard to look at and is not the focus here, so I'm removing it. 
```{r effect x nadded}

ggplot(data = singletons_effect, aes(x = nadded, y = skewdiff)) +
  geom_point(alpha = .1) +
  theme_bw() +
  facet_wrap(vars(dat), scales = 'free_x')

ggplot(data = singletons_effect, aes(x = propadded, y = skewdiff)) +
  geom_point(alpha = .1) +
  theme_bw() +
    facet_wrap(vars(dat), scales = 'free_x')


ggplot(data = singletons_effect, aes(x = nadded, y = simpdiff)) +
  geom_point(alpha = .1) +
  theme_bw() +
  facet_wrap(vars(dat), scales = 'free_x')

ggplot(data = singletons_effect, aes(x = propadded, y = simpdiff)) +
  geom_point(alpha = .1) +
  theme_bw() +
    facet_wrap(vars(dat), scales = 'free_x')

```

Compared to original skew

```{r skewFALSE}

ggplot(data = singletons_effect, aes(x = skew_percentile_FALSE, y = skewdiff)) +
   geom_point(alpha = .1) +
  theme_bw() +
  geom_hline(yintercept = 0, color = "red") +
  geom_smooth(method = "lm", se = F)

ggplot(data = singletons_effect, aes(x = skew_percentile_FALSE, y = skewdiff)) +
   geom_point(alpha = .1) +
  theme_bw() +
  geom_hline(yintercept = 0, color = "red") +
  geom_smooth(method = "lm", se = F) +
  facet_wrap(vars(dat), scales = "free")


```
