---
title: "Synthesis report"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)

all_di <- read.csv(here::here("analysis", "reports", "all_di.csv"), stringsAsFactors = F)

all_di <- all_di %>%
  mutate(log_nparts = log(gmp:::as.double.bigz(nparts)),
         log_nsamples = log(nsamples)) %>%
  mutate(prop_found = exp(log_nsamples - log_nparts))
```

# Datasets in S and N space

Here is where our communities fall in S and N space:

```{r datasets in s and n space}
ggplot(filter(all_di, singletons == F), aes(x = log(s0), y = log(n0), color = dat)) +
  geom_point(alpha = .8) +
  theme_bw() +
  scale_color_viridis_d()

```

Here is how that translates into the size of the feasible set:

```{r size of fs}
ggplot(filter(all_di, singletons == F), aes(x = log(s0), y = log(n0), color = log_nparts)) +
  geom_point(alpha = .5) +
  theme_bw() +
  scale_color_viridis_c(option = "magma", end = .9, begin = .1)

```

Note that the color scale is log transformed, so the largest communities have e^`r max(all_di$log_nparts)`, or `r exp(max(all_di$log_nparts))`, elements in the feasible set!

Here is how the size of the feasible set maps on to N/S:

```{r nparts vs avgn}
ggplot(filter(all_di, singletons == F), aes(x = log(n0 / s0), y = log_nparts, color = log(s0))) +
  theme_bw() +
  geom_point(alpha = .2) +
  scale_color_viridis_c()

```

# Number of samples

Here is how many samples we are achieving:

```{r nsamples}
ggplot(filter(all_di, singletons == F), aes(x = log(s0), y = log(n0), color = log_nsamples)) +
  geom_point(alpha = .3) +
  theme_bw() +
  scale_color_viridis_c(option = "magma", end = .9)

ggplot(filter(all_di, singletons == F, nsamples <  max(nsamples)), aes(x = log(s0), y = log(n0), color = log_nsamples)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(option = "magma", end = .9)
```

Only in the very smallest communities do we get appreciably fewer than `r max(all_di$nsamples)` samples.

Here is how the number of samples we're getting compares to the size of the feasible set:

```{r nsamples vs nparts}
ggplot(filter(all_di, singletons == F), aes(x = prop_found)) +
  theme_bw() +
  geom_histogram(bins = 100)

ggplot(filter(all_di, singletons == F), aes(x = log(s0), y = log(n0), color = prop_found)) +
  geom_point(alpha = .7) +
  geom_point(data = filter(all_di, singletons == F, prop_found == 1), color = "grey") +
  theme_bw() +
  scale_color_viridis_c(option = "magma", end = .9, direction = -1) +
  theme(legend.position = "top")

ggplot(filter(all_di, singletons == F), aes(x = prop_found, y =nsamples)) +
  theme_bw() +
  geom_vline(xintercept = c((.95), (.1))) +
  geom_point(alpha = .3) +
  geom_point(data = filter(all_di, singletons == F, prop_found == 1), color = "grey")


prop_found_ecdf <- ecdf(filter(all_di,singletons == F)$prop_found)

pf_df <- data.frame(prop_found = seq(0, 1, by = 0.001),
                    cdf = prop_found_ecdf(seq(0, 1, by = 0.001)))

ggplot(data = pf_df, aes(x = prop_found, y = cdf)) +
  geom_line() +
  theme_bw()

```

For about `r 100 * mean(filter(all_di, singletons == F)$prop_found == 1)`% of sites, we found all the elements of the FS. The *vast majority* of this is FIA.




# 
