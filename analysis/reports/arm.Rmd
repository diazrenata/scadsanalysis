---
title: "Investigating the arm + Gentry U"
output: 
  github_document
params:
  on_hpg: [FALSE]
---

Gentry has an interesting "arm" up where the values get weird, and I'm wondering if that's where the U-shape in the percentile value histograms comes from.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)
library(scadsanalysis)

if(params$on_hpg) {
  
  all_di <- list() 
  datasets <- c("bbs", "fia_short", "gentry", "mcdb", "misc_abund_short", "portal_plants")
  
  #datasets <- c("fia", "gentry", "mcdb", "misc_abund_short", "portal_plants")
  
  for(i in 1:length(datasets)) {
    
    this_dataset = datasets[i]
    if(this_dataset == "misc_abund_short") {
      cache_loc = "miscabund"
    } else if(this_dataset == "fia_short") {
      
      cache_loc = "fia"
    } else {
      cache_loc = this_dataset
    }
    
    ## Set up the cache and config
    db <- DBI::dbConnect(RSQLite::SQLite(), here::here("analysis", "drake", paste0("drake-cache-", cache_loc, ".sqlite")))
    cache <- storr::storr_dbi("datatable", "keystable", db)
    
    all_di[[i]] <- readd(all_di_obs, cache = cache)
    
    all_di[[i]] <- filter(all_di[[i]], source == "observed")
    
    this_dat <- readd(paste0("dat_s_dat_", this_dataset), cache = cache, character_only = T)
    sv <- get_statevars(this_dat)
    all_di[[i]] <- left_join(all_di[[i]], sv, by = c("sim", "site", "source", "singletons", "dat"))
    
    
    DBI::dbDisconnect(db)
    rm(cache)
    rm(db)
  }
  
  
  all_di <- bind_rows(all_di)
  
  write.csv(all_di, "all_di.csv", row.names = F)
} else {
  all_di <- read.csv(here::here("analysis", "reports", "all_di.csv"), stringsAsFactors = F)
}

all_di <- filter(all_di, dat == "gentry")
```

## Number of draws in feasible set


```{r draws v sn plots, fig.dim = c(5,5)}

ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = log(nsamples))) +
    geom_point(alpha = .5) + 
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9)

ggplot(data=all_di, aes(x = log(s0), y = log(n0), color = log(n0/s0))) +    geom_point(alpha = .5) + 
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9)


```

The "arm" is well-sampled, but note that log(n0/s0) approaches zero. I'd call anything that's really purple - log(n0/s0) <= 1, let's say - "arm" territory. That's where n0/s0 is down below 2.5:1-ish.

## Percentile value vs. range of variation of FS

```{r Simpson rov, fig.dim=c(4,4)}

ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = simpson_mean)) +
  geom_point(alpha = .5) +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9) +
  theme(legend.position = "top") +
  ggtitle("Simpson mean")
ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = simpson_sd)) +
  geom_point(alpha = .5) +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9)+
  theme(legend.position = "top") +
  ggtitle("Simpson sd")
ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = simpson_range)) +
  geom_point(alpha = .5) +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9)+
  theme(legend.position = "top") +
  ggtitle("Simpson range")
ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = simpson_percentile)) +
  geom_point(alpha = .5) +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9, direction = -1)+
  theme(legend.position = "top") +
  ggtitle("Simpson percentile")

```


```{r skew rov, fig.dim=c(4,4)}

ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = skew_mean)) +
  geom_point(alpha = .5) +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9, direction = -1) +
  theme(legend.position = "top") +
  ggtitle("Skew mean")
ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = skew_sd)) +
  geom_point(alpha = .5) +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9, direction = -1)+
  theme(legend.position = "top") +
  ggtitle("Skew sd")
ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = skew_range)) +
  geom_point(alpha = .5) +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9, direction = -1)+
  theme(legend.position = "top") +
  ggtitle("Skew range")
ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = skew_percentile)) +
  geom_point(alpha = .5) +
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9)+
  theme(legend.position = "top") +
  ggtitle("Skew percentile")


```
All of the FS properties get weird up the arm. 

Simpson gets high, the sd gets down to almost zero, and the range drops. Skew gets - bizarrely? - *large*. (But absolute skewness values are...slippery and counterintuitive). 

The super high evenness percentiles are all up the arm. There's more fuzz in skewness, but most of the low skewness values are also up the arm.


```{r avg n percentile}

ggplot(data = filter(all_di, nsamples >= 2000, singletons == F), aes(x = log(n0/s0), y = skew_percentile)) +
  geom_point(alpha = .5) +
  theme_bw()


ggplot(data = filter(all_di, nsamples >= 2000, singletons == F), aes(x = log(n0/s0), y = simpson_percentile)) +
  geom_point(alpha = .5) +
  theme_bw()
```


There is a constraining-ish envelope where the low skew values are all at low average abundance (log n0/s0 < ~1.6) and the high evenness values are similarly collected (log n0/s0 < ~1.7, mostly < 1). 

## Percentile results

```{r overall}

ggplot(data = filter(all_di, nsamples >= 2000, singletons == FALSE), aes(x = skew_percentile)) +
  geom_histogram(bins = 100, aes(y = stat(count / sum(count)))) +
  theme_bw() +
  geom_hline(yintercept = .01, linetype = 3)

ggplot(data = filter(all_di, nsamples >= 2000, singletons == FALSE), aes(x = simpson_percentile)) +
  geom_histogram(bins = 100, aes(y = stat(count / sum(count)))) +
  theme_bw() +
    geom_hline(yintercept = .01, linetype = 3)

```

Let's exclude log n0/s0 < 1.5.

```{r no arm}

all_di <- all_di %>%
  mutate(avgn = log(n0/s0))

ggplot(data = filter(all_di, nsamples >= 2000, singletons == FALSE, avgn >= 1.5), aes(x = skew_percentile)) +
  geom_histogram(bins = 100, aes(y = stat(count / sum(count)))) +
  theme_bw() +
  geom_hline(yintercept = .01, linetype = 3)

ggplot(data = filter(all_di, nsamples >= 2000, singletons == FALSE, avgn >= 1.5), aes(x = simpson_percentile)) +
  geom_histogram(bins = 100, aes(y = stat(count / sum(count)))) +
  theme_bw() +
    geom_hline(yintercept = .01, linetype = 3)
```

Well that clears THAT up.

Effect of singletons

```{r singletons overall}

singletons_effect <- all_di %>%
  select(dat, nsamples, site, singletons, skew_percentile, simpson_percentile) %>%
  tidyr::pivot_wider(names_from = singletons, values_from = c(skew_percentile, simpson_percentile, nsamples)) %>%
  mutate(skewdiff = skew_percentile_TRUE - skew_percentile_FALSE,
         simpdiff= simpson_percentile_TRUE - simpson_percentile_FALSE) %>%
  filter(nsamples_TRUE >= 2000, nsamples_FALSE >= 2000)

ggplot(data = singletons_effect, aes(x = skew_percentile_FALSE, y = skew_percentile_TRUE)) +
  geom_point(alpha = .5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green")

ggplot(data = singletons_effect, aes(x = simpson_percentile_FALSE, y = simpson_percentile_TRUE)) +
    geom_point(alpha = .5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green")

```

The rarefaction-inflated datasets are strongly // the raw vectors. They have more extreme skewness and evenness values, relative to their feasible sets, than the raw vectors. This is almost always true for evenness, with a little more noise in the skewness signal. But either way, very strong. 

Just out of curiousity, removing the arm...


```{r singletons no arm}

singletons_effect_noarm <- all_di %>%
  select(dat, nsamples, site, avgn, singletons, skew_percentile, simpson_percentile) %>%
  tidyr::pivot_wider(names_from = singletons, values_from = c(skew_percentile, simpson_percentile, nsamples, avgn)) %>%
  mutate(skewdiff = skew_percentile_TRUE - skew_percentile_FALSE,
         simpdiff= simpson_percentile_TRUE - simpson_percentile_FALSE) %>%
  filter(nsamples_TRUE >= 2000, nsamples_FALSE >= 2000,
         avgn_TRUE >= 1.5, avgn_FALSE >= 1.5)

ggplot(data = singletons_effect_noarm, aes(x = skew_percentile_FALSE, y = skew_percentile_TRUE)) +
  geom_point(alpha = .5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green")

ggplot(data = singletons_effect_noarm, aes(x = simpson_percentile_FALSE, y = simpson_percentile_TRUE)) +
    geom_point(alpha = .5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green")

```


Huh. Those are tidier, too. 

## FS in the arm

Let's look at what the actual feasible sets look like up the arm vs. elsewhere. 

```{r fs in the arm}
if(params$on_hpg) {
  
## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), here::here("analysis", "drake", "drake-cache-gentry.sqlite"))
cache <- storr::storr_dbi("datatable", "keystable", db)

} else {
## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), "/Users/renatadiaz/Desktop/caches_good/drake-cache-gentry.sqlite")
cache <- storr::storr_dbi("datatable", "keystable", db)
}
loadd(fs_35_FALSE, cache = cache)

ggplot(data = filter(fs_35_FALSE, source == "sampled"), aes(x = rank, y = abund, group = sim)) +
  geom_line(alpha = .05) +
  geom_line(data = filter(fs_35_FALSE, source == "observed"), alpha = 1, color = "green") +
  theme_bw()




loadd(fs_184_FALSE, cache = cache)

ggplot(data = filter(fs_184_FALSE, source == "sampled"), aes(x = rank, y = abund, group = sim)) +
  geom_line(alpha = .05) +
  geom_line(data = filter(fs_184_FALSE, source == "observed"), alpha = 1, color = "green") +
  theme_bw()

max(fs_184_FALSE$sim)
DBI::dbDisconnect(db)
rm(cache)
```
