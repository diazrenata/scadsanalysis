---
title: "Shaking out the idiosyncracies"
output: 
  github_document
params:
  on_hpg: [FALSE]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)
library(scadsanalysis)

if(params$on_hpg) {
  
  all_di <- list() 
  datasets <- c("bbs", "fia_short", "gentry", "mcdb", "misc_abund_short", "portal_plants")
  
  #datasets <- c("fia", "gentry", "mcdb", "misc_abund_short", "portal_plants")
  
  for(i in 1:length(datasets)) {
    
    this_dataset = datasets[i]
    if(this_dataset == "misc_abund_short") {
      cache_loc = "miscabund"
    } else if(this_dataset == "fia_short") {
      
      cache_loc = "fia"
    } else {
      cache_loc = this_dataset
    }
    
    ## Set up the cache and config
    db <- DBI::dbConnect(RSQLite::SQLite(), here::here("analysis", "drake", paste0("drake-cache-", cache_loc, ".sqlite")))
    cache <- storr::storr_dbi("datatable", "keystable", db)
    
    all_di[[i]] <- readd(all_di_obs, cache = cache)
    
    all_di[[i]] <- filter(all_di[[i]], source == "observed")
    
    this_dat <- readd(paste0("dat_s_dat_", this_dataset), cache = cache, character_only = T)
    sv <- get_statevars(this_dat)
    all_di[[i]] <- left_join(all_di[[i]], sv, by = c("sim", "site", "source", "singletons", "dat"))
    
    
    DBI::dbDisconnect(db)
    rm(cache)
    rm(db)
  }
  
  
  all_di <- bind_rows(all_di)
  
  write.csv(all_di, "all_di.csv", row.names = F)
} else {
  all_di <- read.csv(here::here("analysis", "reports", "all_di.csv"), stringsAsFactors = F)
}
```

## Number of draws in feasible set

For low values of S and N, we expect to get considerably fewer than 2500 unique draws from the feasible set. Small feasible sets present a couple of problems for this percentile approach:

- In the limit of only one or a handful of possible forms, it's absurd to try and draw meaning from the form of the SAD. In a community of 10 species and 11 individuals, the important thing to understand is not why the SAD is 2-1-1-1-1-1 but why the community has 10 species and 11 individuals. 
- Even when there are a few more possible forms, if there isn't much variation, the %ile statistic will be pretty coarse. 
- I expect the central tendency/dominance by a particular *form* to be weaker when there are fewer possible forms, period. 
- This one isn't necessarily a bug (and it applies to other aspects of S x N space), but I expect combinations of S and N that produce samples to have unusual feasible sets compared to most of S and N space. These are going to be communities with either very low S and N, period, or *very few* individuals relative to S. They will be forced to be more even than ones with more individuals. 

It's not clear a priori what actual values of S and N will push us into small-community problems. Again, beyond the really small communities, it really depends on the ratio. Early on I just filtered out anything that gave fewer than 2000 unique draws. This has the advantage that we only end up comparing %ile values with reasonably comparable precision, but it might artificially exclude an important region on S*N space. 

```{r draws v sn plots, fig.dim = c(8,8)}

ndraws_plot <- ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = log(nsamples))) +
  geom_point(data = filter(all_di, nsamples >= 2000), color = "grey", alpha = .25) +
    geom_point(data = filter(all_di, nsamples <2000), alpha = .1) + 
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9)

ndraws_plot

ndraws_onlysmol_plot <- ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = log(nsamples))) +
    geom_point(data = filter(all_di, nsamples <2000), alpha = .1) + 
  theme_bw() +
  scale_color_viridis_c(option = "plasma", end = .9)

ndraws_onlysmol_plot
```

In these plots, the grey region is nsamples >= 2000. It looks like removing communities with nsamples < 2000 is basically filtering out N < about 100-150. For more nuance we could dip down into lower n for intermediate S (S between 5 and 50), and still be getting pretty good sampling? 

Leaving it be for now.

## Percentile value vs. range of variation of FS

This is really hard to get traction on. S and N affect everything. 

```{r percent v rov}

ggplot(data = filter(all_di, nsamples >= 2000), aes(x = simpson_sd, y =simpson_percentile, color = simpson_mean)) +
  geom_point(alpha = .05) +
  theme_bw() +  scale_color_viridis_c(option = "plasma", end = .9)

ggplot(data = filter(all_di, nsamples >= 2000), aes(x = skew_sd, y =skew_percentile, color = skew_mean)) +
  geom_point(alpha = .05) +
  theme_bw() +  scale_color_viridis_c(option = "plasma", end = .9)


```

## Where the datasets fall

```{r dataset space}
ggplot(data = all_di, aes(x = log(s0), y = log(n0), color = dat)) + 
  geom_point(alpha = .2) +
  scale_color_viridis_d() +
  theme_bw()

ggplot(data = all_di, aes(x = nsamples)) +
  geom_histogram() +
  theme_bw()+
  facet_wrap(vars(dat), scales = "free_y") +
  geom_vline(xintercept = 2000)
```

The datasets overlap but do occupy broadly different regions of S*N space.

FIA, dramatically more than any other dataset, struggles to get even 2000 samples. 

## Overall percentile results

```{r overall}

ggplot(data = filter(all_di, nsamples >= 2000, singletons == FALSE), aes(x = skew_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw()

ggplot(data = filter(all_di, nsamples >= 2000, singletons == FALSE), aes(x = simpson_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() 

```

Effect of singletons

```{r singletons overall}

singletons_effect <- all_di %>%
  select(dat, nsamples, site, singletons, skew_percentile, simpson_percentile) %>%
  tidyr::pivot_wider(names_from = singletons, values_from = c(skew_percentile, simpson_percentile, nsamples)) %>%
  mutate(skewdiff = skew_percentile_TRUE - skew_percentile_FALSE,
         simpdiff= simpson_percentile_TRUE - simpson_percentile_FALSE) %>%
  filter(nsamples_TRUE >= 2000, nsamples_FALSE >= 2000)

ggplot(data = singletons_effect, aes(x = skew_percentile_FALSE, y = skew_percentile_TRUE)) +
  geom_point(alpha = .2) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green")

ggplot(data = singletons_effect, aes(x = simpson_percentile_FALSE, y = simpson_percentile_TRUE)) +
    geom_point(alpha = .2) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green")

```

Adding singletons makes skewness more skewed and simpson less even.

## Broken out by dataset

```{r dataset}

ggplot(data = filter(all_di, nsamples >= 2000, singletons == FALSE), aes(x = skew_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(dat), scales = "free_y")

ggplot(data = filter(all_di, nsamples >= 2000, singletons == FALSE), aes(x = simpson_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw()  +
  facet_wrap(vars(dat), scales = "free_y")

```

Effect of singletons

```{r singletons dataset}

singletons_effect <- all_di %>%
  select(dat, nsamples, site, singletons, skew_percentile, simpson_percentile) %>%
  tidyr::pivot_wider(names_from = singletons, values_from = c(skew_percentile, simpson_percentile, nsamples)) %>%
  mutate(skewdiff = skew_percentile_TRUE - skew_percentile_FALSE,
         simpdiff= simpson_percentile_TRUE - simpson_percentile_FALSE) %>%
  filter(nsamples_TRUE >= 2000, nsamples_FALSE >= 2000)

ggplot(data = singletons_effect, aes(x = skew_percentile_FALSE, y = skew_percentile_TRUE)) +
  geom_point(alpha = .2) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green") +
  facet_wrap(vars(dat))

ggplot(data = singletons_effect, aes(x = simpson_percentile_FALSE, y = simpson_percentile_TRUE)) +
    geom_point(alpha = .2) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green") +
  facet_wrap(vars(dat))

```

# MACD

```{r load macd}
  cache_loc = "macdb"

## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), here::here("analysis", "drake", paste0("drake-cache-", cache_loc, ".sqlite")))
cache <- storr::storr_dbi("datatable", "keystable", db)

all_di_macd <- readd(all_di_manip, cache = cache) 

DBI::dbDisconnect(db)
rm(cache)
```

Nsamples

```{r macd overall}

ggplot(data = all_di_macd, aes(x = nsamples)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  geom_vline(xintercept = 2000)

all_di_macd <- filter(all_di_macd, nsamples >= 2000)

ggplot(data = all_di_macd, aes(x = skew_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw()

ggplot(data = all_di_macd, aes(x = simpson_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw()
```

By treatment - overall

```{r macd trtmt overall}


ggplot(data = all_di_macd, aes(x = skew_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(treatment), scales = "free_y")

ggplot(data = all_di_macd, aes(x = simpson_percentile)) +
  geom_histogram(bins = 100) +
  theme_bw() +
  facet_wrap(vars(treatment), scales = "free_y")

```

** I AM REALLY NOT CONFIDENT IN THE DATA HANDLING HERE, NEED TO REVISIT WHEN SHARPER **

```{r macd ctrlcomp}

macd_comparisons <- read.csv(here::here("working-data", "macdb_data", "orderedcomparisons.csv"), header = F, stringsAsFactors = F)

colnames(macd_comparisons) <- c("studyID", "control", "site")
macd_comparisons <- macd_comparisons %>%
  mutate(site = as.character(site), control = as.character(control))

cc_di <- all_di_macd %>%
  filter(singletons == FALSE, treatment == "comparison") %>%
  left_join(macd_comparisons, by = c("studyID", "site")) %>%
  select(dat, site, skew_percentile, simpson_percentile, studyID, control) %>%
  rename(comparison = site) %>%
 left_join(select(all_di_macd, skew_percentile, simpson_percentile, site, singletons, nsamples), by = c("control" = "site")) %>%
  distinct() %>%
  rename(comp_skew = skew_percentile.x, comp_simp = simpson_percentile.x,
         control_skew = skew_percentile.y, control_simp = simpson_percentile.y)

ggplot(data = cc_di, aes(x = comp_skew, y = control_skew)) +
  geom_point(alpha = .5) +
#  xlim(0, 100) +
 # ylim(0, 100) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green")


ggplot(data = cc_di, aes(x = comp_simp, y = control_simp)) +
  geom_point(alpha = .5) +
 xlim(0, 100) +
 ylim(0, 100) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color = "green")

```
